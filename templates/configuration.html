<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if config and config.site_name %}
            OnBoard - {{ config.site_name }}
        {% else %}
            OnBoard
        {% endif %}
    </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    {% if config %}
    <style>
        :root {
            --primary-color: {{ config.primary_color }};
            --primary-dark: {{ config.primary_dark }};
            --secondary-color: {{ config.secondary_color }};
            --secondary-dark: {{ config.secondary_dark }};
            --success-color: {{ config.success_color }};
            --success-dark: {{ config.success_dark }};
            --danger-color: {{ config.danger_color }};
            --danger-dark: {{ config.danger_dark }};
            --background-color: {{ config.background_color }};
            --surface-color: {{ config.surface_color }};
            --text-color: {{ config.text_color }};
            --text-color-light: {{ config.text_color_light }};
            --border-color: {{ config.border_color }};
            --divider-color: {{ config.divider_color }};
        }
    </style>
    {% endif %}
    <style>
        .tabs-nav {
            display: flex;
            margin-bottom: var(--spacing-large);
            border-bottom: 1px solid var(--border-color);
        }
        .tabs-nav li {
            list-style: none;
            padding: var(--spacing-medium) var(--spacing-large);
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: var(--spacing-small);
            border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
            background-color: var(--background-color);
            color: var(--text-color-light);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .tabs-nav li.active {
            background-color: var(--surface-color);
            border-color: var(--border-color);
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 1px solid var(--surface-color);
            position: relative;
            top: 1px;
        }
        .tabs-nav li:hover:not(.active) {
            background-color: var(--divider-color);
            color: var(--text-color);
        }
        .tab-content {
            display: none;
            padding: var(--spacing-large);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--border-radius-medium) var(--border-radius-medium);
            background-color: var(--surface-color);
        }
        .tab-content.active {
            display: block;
            animation: fadeInTab 0.5s ease-in-out;
        }
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content h3, .tab-content h4 {
            text-align: left;
            margin-top: 0;
        }
        .tab-content h4 {
            margin-top: var(--spacing-large);
        }
        .favicon-preview {
            max-width: 32px;
            max-height: 32px;
            margin-left: 10px;
            vertical-align: middle;
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 800px;">
        <h2>Configuration de l'Application</h2>

        <ul class="tabs-nav">
            <li class="tab-link active" data-tab="tab-form">Formulaire & Visiteurs</li>
            <li class="tab-link" data-tab="tab-smtp">Paramètres SMTP</li>
            <li class="tab-link" data-tab="tab-appearance">Personnalisation</li>
            <li class="tab-link" data-tab="tab-user">Utilisateur</li>
        </ul>

        <div id="tab-form" class="tab-content active">
            <form action="{{ url_for('save_pdf') }}" method="POST" enctype="multipart/form-data">
                <h3>Consignes Bâtiment (PDF)</h3>
                <div class="form-group">
                    <label for="pdf_file">Uploader un nouveau PDF de consignes :</label>
                    <input type="file" id="pdf_file" name="pdf_file" accept=".pdf">
                </div>
                <div class="upload-status">
                    {% if pdf_uploaded %}
                        <p>Fichier PDF actuel : <strong>{{ pdf_filename }}</strong>
                        (<a href="{{ url_for('uploaded_pdf_file', filename=pdf_filename) }}" target="_blank">Voir</a>)
                        </p>
                    {% else %}
                        <p>Aucun fichier PDF de consignes n'est actuellement uploadé.</p>
                    {% endif %}
                </div>
                <button type="submit" style="margin-top: 2rem;">Sauvegarder le PDF</button>
            </form>
            <hr style="margin-top:2rem; margin-bottom:2rem;">

            <h3>Personnes à Visiter</h3>
            <form action="{{ url_for('add_person_to_visit') }}" method="POST" id="addPersonForm">
                <div class="form-group">
                    <label for="person_name">Nom de la personne à ajouter :</label>
                    <input type="text" id="person_name" name="person_name" required>
                </div>
                <div class="form-group">
                    <label for="person_email">Email de la personne à ajouter :</label>
                    <input type="email" id="person_email" name="person_email" required>
                </div>
                <button type="submit">Ajouter Personne</button>
            </form>
            <div class="person-list" style="margin-top: var(--spacing-large);">
                <h5>Liste actuelle des personnes à visiter :</h5>
                {% if people_to_visit %}
                    <ul>
                        {% for person in people_to_visit %}
                            <li class="person-item" style="display: flex; align-items: center; justify-content: space-between;">
                                <span>{{ person.name }} ({{ person.email }})</span>
                                <form action="{{ url_for('delete_person_to_visit', person_id=person.id) }}" method="post" style="margin:0;display:inline;" onsubmit="return confirm('Supprimer cette personne ?');">
                                    <button type="submit" title="Supprimer" style="background: none; border: none; color: #dc3545; font-size: 1.3em; cursor: pointer; padding: 0 0.5em;">
                                        &times;
                                    </button>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Aucune personne à visiter enregistrée pour l'instant.</p>
                {% endif %}
            </div>
            <hr style="margin-top:2rem; margin-bottom:2rem;">

            <h3>Emails de notification (toujours prévenus)</h3>
            <form action="{{ url_for('add_notification_email') }}" method="POST" id="addNotifEmailForm">
                <div class="form-group">
                    <label for="notif_email">Adresse email à ajouter :</label>
                    <input type="email" id="notif_email" name="notif_email" required>
                </div>
                <button type="submit">Ajouter Email</button>
            </form>
            <div class="person-list" style="margin-top: var(--spacing-large);">
                <h5>Liste actuelle des emails de notification :</h5>
                {% if notification_emails %}
                    <ul>
                        {% for notif in notification_emails %}
                            <li class="person-item" style="display: flex; align-items: center; justify-content: space-between;">
                                <span>{{ notif.email }}</span>
                                <form action="{{ url_for('delete_notification_email', notif_id=notif.id) }}" method="post" style="margin:0;display:inline;" onsubmit="return confirm('Supprimer cet email ?');">
                                    <button type="submit" title="Supprimer" style="background: none; border: none; color: #dc3545; font-size: 1.3em; cursor: pointer; padding: 0 0.5em;">
                                        &times;
                                    </button>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Aucun email de notification enregistré pour l'instant.</p>
                {% endif %}
            </div>
            <hr style="margin-top:2rem; margin-bottom:2rem;">

            <h3>Nom du site</h3>
            <form action="{{ url_for('save_site_name') }}" method="POST">
                <div class="form-group">
                    <label for="site_name">Nom du site :</label>
                    <input type="text" id="site_name" name="site_name" value="{{ config.site_name if config and config.site_name else '' }}" required>
                </div>
                <button type="submit">Sauvegarder le nom du site</button>
            </form>
        </div>

        <!-- Formulaire SMTP -->
        <div id="tab-smtp" class="tab-content">
            <form action="{{ url_for('save_smtp') }}" method="POST">
                <h3>Paramètres SMTP</h3>
                <div class="form-group">
                    <label for="smtp_server">Serveur SMTP :</label>
                    <input type="text" id="smtp_server" name="smtp_server" value="{{ config.smtp_server if config else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="smtp_port">Port SMTP :</label>
                    <input type="number" id="smtp_port" name="smtp_port" value="{{ config.smtp_port if config else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="smtp_user">Nom d'utilisateur SMTP :</label>
                    <input type="text" id="smtp_user" name="smtp_user" value="{{ config.smtp_user if config else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="smtp_password">Mot de passe SMTP :</label>
                    <input type="password" id="smtp_password" name="smtp_password" value="{{ config.smtp_password if config else '' }}" required>
                </div>
                <div class="form-group">
                    <label for="sender_email">Email de l'expéditeur :</label>
                    <input type="email" id="sender_email" name="sender_email" value="{{ config.sender_email if config else '' }}" required>
                </div>
                <button type="submit">Sauvegarder SMTP</button>
            </form>
        </div>

        <!-- Formulaire Apparence -->
        <div id="tab-appearance" class="tab-content">
            <form action="{{ url_for('save_appearance') }}" method="POST" enctype="multipart/form-data">
                <h3>Personnalisation de l'Apparence</h3>
                <h4>Couleurs de l'Interface</h4>
                <div class="color-grid">
                    <div>
                        <label for="primary_color">Primaire :</label>
                        <input type="color" id="primary_color" name="primary_color" value="{{ config.primary_color if config else '#007bff' }}">
                    </div>
                    <div>
                        <label for="primary_dark">Primaire foncé :</label>
                        <input type="color" id="primary_dark" name="primary_dark" value="{{ config.primary_dark if config else '#0056b3' }}">
                    </div>
                    <div>
                        <label for="secondary_color">Secondaire :</label>
                        <input type="color" id="secondary_color" name="secondary_color" value="{{ config.secondary_color if config else '#6c757d' }}">
                    </div>
                    <div>
                        <label for="secondary_dark">Secondaire foncé :</label>
                        <input type="color" id="secondary_dark" name="secondary_dark" value="{{ config.secondary_dark if config else '#5a6268' }}">
                    </div>
                    <div>
                        <label for="success_color">Succès :</label>
                        <input type="color" id="success_color" name="success_color" value="{{ config.success_color if config else '#28a745' }}">
                    </div>
                    <div>
                        <label for="success_dark">Succès foncé :</label>
                        <input type="color" id="success_dark" name="success_dark" value="{{ config.success_dark if config else '#218838' }}">
                    </div>
                    <div>
                        <label for="danger_color">Danger :</label>
                        <input type="color" id="danger_color" name="danger_color" value="{{ config.danger_color if config else '#dc3545' }}">
                    </div>
                    <div>
                        <label for="danger_dark">Danger foncé :</label>
                        <input type="color" id="danger_dark" name="danger_dark" value="{{ config.danger_dark if config else '#c82333' }}">
                    </div>
                    <div>
                        <label for="background_color">Fond :</label>
                        <input type="color" id="background_color" name="background_color" value="{{ config.background_color if config else '#f8f9fa' }}">
                    </div>
                    <div>
                        <label for="surface_color">Surface :</label>
                        <input type="color" id="surface_color" name="surface_color" value="{{ config.surface_color if config else '#ffffff' }}">
                    </div>
                    <div>
                        <label for="text_color">Texte :</label>
                        <input type="color" id="text_color" name="text_color" value="{{ config.text_color if config else '#343a40' }}">
                    </div>
                    <div>
                        <label for="text_color_light">Texte clair :</label>
                        <input type="color" id="text_color_light" name="text_color_light" value="{{ config.text_color_light if config else '#6c757d' }}">
                    </div>
                    <div>
                        <label for="border_color">Bordure :</label>
                        <input type="color" id="border_color" name="border_color" value="{{ config.border_color if config else '#ced4da' }}">
                    </div>
                    <div>
                        <label for="divider_color">Séparateur :</label>
                        <input type="color" id="divider_color" name="divider_color" value="{{ config.divider_color if config else '#e9ecef' }}">
                    </div>
                </div>

                <hr style="margin: var(--spacing-extra-large) 0;">
                <h4>Logo de l'Application</h4>
                <div class="form-group">
                    <label for="logo_file">Uploader un logo (.png, .jpg, .jpeg, .gif, .svg):</label>
                    <input type="file" id="logo_file" name="logo_file" accept=".png,.jpg,.jpeg,.gif,.svg">
                    {% if config.logo_filename %}
                        <div style="margin-top:0.5em; display: flex; align-items: center; gap: 1rem;">
                            <img src="{{ url_for('static', filename='logos/' + config.logo_filename) }}" alt="Logo actuel" style="max-height: 60px; max-width: 200px; vertical-align: middle;">
                            <strong>{{ config.logo_filename }}</strong>
                        </div>
                    {% else %}
                        <div style="margin-top:0.5em; color:var(--text-color-light);">Aucun logo personnalisé n'est actuellement uploadé.</div>
                    {% endif %}
                </div>
                <button type="submit">Sauvegarder l'apparence</button>
            </form>
        </div>

        <div id="tab-user" class="tab-content">
            <h3>Gestion de l'utilisateur administrateur</h3>
            <form action="{{ url_for('change_admin_password') }}" method="post" style="max-width:350px;margin:auto;">
                <label for="new_admin_password">Nouveau mot de passe :</label>
                <input type="password" name="new_admin_password" id="new_admin_password" required style="width:100%;margin-bottom:1em;">
                <button type="submit">Changer le mot de passe</button>
            </form>
        </div>

        <div class="back-link" style="margin-top: var(--spacing-extra-large);">
            <a href="{{ url_for('index') }}">Retour à l'accueil</a>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const tabLinks = document.querySelectorAll('.tabs-nav li.tab-link');
    const tabContentElements = {
        'tab-form': document.getElementById('tab-form'),
        'tab-smtp': document.getElementById('tab-smtp'),
        'tab-appearance': document.getElementById('tab-appearance'),
        'tab-user': document.getElementById('tab-user') // AJOUT
    };

    function showTab(targetTabKey) {
        Object.values(tabContentElements).forEach(contentEl => {
            if (contentEl) contentEl.classList.remove('active');
        });
        tabLinks.forEach(link => link.classList.remove('active'));
        const clickedTabLink = document.querySelector(`.tabs-nav li[data-tab='${targetTabKey}']`);
        if (clickedTabLink) {
            clickedTabLink.classList.add('active');
        }
        if (tabContentElements[targetTabKey]) {
            tabContentElements[targetTabKey].classList.add('active');
        }
    }

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    const tabParam = getUrlParameter('tab');
    if (tabParam && tabContentElements[tabParam]) {
        showTab(tabParam);
    } else {
        const initialActiveTabLink = document.querySelector('.tabs-nav li.tab-link.active');
        if (initialActiveTabLink) {
            showTab(initialActiveTabLink.dataset.tab);
        } else if (tabLinks.length > 0) {
            tabLinks[0].classList.add('active');
            showTab(tabLinks[0].dataset.tab);
        }
    }

    tabLinks.forEach(link => {
        link.addEventListener('click', function (event) {
            event.preventDefault();
            const targetTabKey = this.dataset.tab;
            showTab(targetTabKey);
        });
    });
});
    </script>
    <script>
window.addEventListener('beforeunload', function () {
    // Appel synchrone pour garantir l'exécution avant fermeture
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "{{ url_for('logout') }}", false); // false = synchrone
    xhr.send();
});
    </script>
</body>
</html>